<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘åŒæ­¥è°ƒè¯•å·¥å…·</title>
    <script src="config/sync-config.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; font-size: 12px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ äº‘åŒæ­¥è°ƒè¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>ç¯å¢ƒä¿¡æ¯</h3>
        <div id="envInfo"></div>
    </div>
    
    <div class="test-section">
        <h3>CORSæµ‹è¯•</h3>
        <button onclick="testDirectCors()">æµ‹è¯•ç›´æ¥Vercel CORS</button>
        <button onclick="testNetlifyProxy()">æµ‹è¯•Netlifyä»£ç†</button>
        <div id="corsResults"></div>
    </div>
    
    <div class="test-section">
        <h3>APIè¿æ¥æµ‹è¯•</h3>
        <button onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
        <div id="apiResults"></div>
    </div>
    
    <div class="test-section">
        <h3>å®Œæ•´åŒæ­¥æµ‹è¯•</h3>
        <input type="text" id="testSyncKey" placeholder="è¾“å…¥æµ‹è¯•åŒæ­¥å¯†é’¥" value="debug-test-key">
        <button onclick="testFullSync()">æµ‹è¯•å®Œæ•´åŒæ­¥æµç¨‹</button>
        <div id="syncResults"></div>
    </div>

    <script>
        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvInfo() {
            const info = {
                hostname: window.location.hostname,
                origin: window.location.origin,
                userAgent: navigator.userAgent.substring(0, 100),
                configuredApiBase: window.SyncConfig ? window.SyncConfig.getApiBaseUrl() : 'SyncConfig not loaded',
                uploadUrl: window.SyncConfig ? window.SyncConfig.getApiUrl('upload') : 'N/A',
                downloadUrl: window.SyncConfig ? window.SyncConfig.getApiUrl('download') : 'N/A'
            };
            
            document.getElementById('envInfo').innerHTML = `<pre>${JSON.stringify(info, null, 2)}</pre>`;
        }
        
        // æµ‹è¯•ç›´æ¥Vercel CORS
        async function testDirectCors() {
            const resultsDiv = document.getElementById('corsResults');
            resultsDiv.innerHTML += '<div class="info">æ­£åœ¨æµ‹è¯•ç›´æ¥Vercel CORS...</div>';
            
            try {
                const response = await fetch('https://freeapp-git-sync-tosd0.vercel.app/api/sync/upload', {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                resultsDiv.innerHTML += `<div class="success">âœ… ç›´æ¥CORSæµ‹è¯•æˆåŠŸ - çŠ¶æ€: ${response.status}, CORSå¤´: ${corsHeader}</div>`;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">âŒ ç›´æ¥CORSæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•Netlifyä»£ç†
        async function testNetlifyProxy() {
            const resultsDiv = document.getElementById('corsResults');
            resultsDiv.innerHTML += '<div class="info">æ­£åœ¨æµ‹è¯•Netlifyä»£ç†...</div>';
            
            try {
                const response = await fetch('/.netlify/functions/sync-proxy?endpoint=upload', {
                    method: 'OPTIONS'
                });
                
                resultsDiv.innerHTML += `<div class="success">âœ… Netlifyä»£ç†æµ‹è¯•æˆåŠŸ - çŠ¶æ€: ${response.status}</div>`;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">âŒ Netlifyä»£ç†æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•APIè¿æ¥...</div>';
            
            const testUrl = window.SyncConfig ? window.SyncConfig.getApiUrl('manage') : '/api/sync/manage';
            
            try {
                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'stats',
                        adminKey: 'test'
                    })
                });
                
                const text = await response.text();
                let result;
                
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    result = { parseError: true, rawResponse: text.substring(0, 300) };
                }
                
                resultsDiv.innerHTML = `
                    <div class="info">APIå“åº”çŠ¶æ€: ${response.status}</div>
                    <div class="info">å“åº”å†…å®¹ç±»å‹: ${response.headers.get('content-type')}</div>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æµ‹è¯•å®Œæ•´åŒæ­¥
        async function testFullSync() {
            const syncKey = document.getElementById('testSyncKey').value;
            const resultsDiv = document.getElementById('syncResults');
            
            if (!syncKey) {
                resultsDiv.innerHTML = '<div class="error">è¯·è¾“å…¥æµ‹è¯•åŒæ­¥å¯†é’¥</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•å®Œæ•´åŒæ­¥æµç¨‹...</div>';
            
            // æµ‹è¯•æ•°æ®
            const testData = {
                test: true,
                timestamp: new Date().toISOString(),
                data: { message: "è¿™æ˜¯æµ‹è¯•æ•°æ®" }
            };
            
            try {
                // æµ‹è¯•ä¸Šä¼ 
                const uploadUrl = window.SyncConfig ? window.SyncConfig.getApiUrl('upload') : '/api/sync/upload';
                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        syncKey: syncKey,
                        data: testData
                    })
                });
                
                const uploadResult = await uploadResponse.text();
                resultsDiv.innerHTML += `<div class="info">ä¸Šä¼ å“åº” (${uploadResponse.status}):</div><pre>${uploadResult}</pre>`;
                
                if (uploadResponse.ok) {
                    // æµ‹è¯•ä¸‹è½½
                    const downloadUrl = window.SyncConfig ? window.SyncConfig.getApiUrl('download') : '/api/sync/download';
                    const downloadResponse = await fetch(downloadUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            syncKey: syncKey
                        })
                    });
                    
                    const downloadResult = await downloadResponse.text();
                    resultsDiv.innerHTML += `<div class="info">ä¸‹è½½å“åº” (${downloadResponse.status}):</div><pre>${downloadResult}</pre>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="error">âŒ åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        window.onload = showEnvInfo;
    </script>
</body>
</html>